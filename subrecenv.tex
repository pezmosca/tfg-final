\chapter{Subsistema de recolección y envío}

\section{Arquitectura del subsistema}
El subsistema de recolección y envío está formado por dos módulos, los cuales actúan en el dispositivo ubicuo. Esta es una división a nivel lógico y existe para reducir a problemas más simples el problema general, aunque nada impide que una herramienta implemente dos módulos.

%%Figura de la arquitectura

\subsection{Módulo de recolección}
El módulo de recolección es el encargado de recoger los eventos en el dispositivo ubicuo, para que luego el módulo de envío pueda consumirlos. 
\\\\
En concreto para este proyecto los eventos que se recogerán serán logs y crashlogs. Los logs servirán para llevar a cabo la monitorización y los crashlogs el seguimiento de errores.
\\\\
Para generar logs se han de explicitar en el código ahí donde el programador considere adecuado, los crashlogs se generan automáticamente cuando la aplicación termina inesperadamente.
\\\\
Los logs se recolectan en tiempo de ejecución y se almacenan en el dispositivo ubicuo para que el módulo de envío los consuma cuando sea pertinente.
\\\\
Los crashlogs se recolectan cuando la aplicación termina inesperadamente y no se almacenan en el dispositivo, sino que de forma inmediata el módulo de envío los consume. Se ha decidido que no se almacenen en el dispositivo puesto que, se considera que tienen más prioridad que los logs, y porque no se puede asegurar que se lleguen a almacenar en el dispositivo o que la aplicación pueda volverse a abrir después de que el crash haya sucedido. Así pues se invoca directamente al módulo de envío para que consuma tal crashlog.

\subsection{Módulo de envío}
El módulo de envío es el encargado de consumir los eventos que ha recolectado el módulo de recolección y enviar tales eventos al módulo de recepción del subsistema de recepción e ingesta.
\\\\
El envío de los logs lo hace cuando la aplicación se cierra correctamente. Es entonces cuando consume los logs almacenados en el dispositivo y los envía al módulo de recepción.
\\\\
El envío de los crashlogs lo hace cuando la aplicación se ha cerrado inesperadamente. Es entonces cuando consume el crash generado y lo envía al módulo de recepción.

\section{Estructura del sistema}

\subsection{Módulo de recolección}
El módulo de recolección está integrado por dos librerías. Una librería se encarga de recolectar los logs y otra los crashlogs.
\\\\
La librería encargada de recolectar logs como mínimo ha de permitir que el programador defina logs en el punto del programa donde este considere oportuno, y que se pueda definir el destino de los logs.

La librería encargada de recolectar crashlogs como mínimo ha de identificar cuando se ha producido un cierre inesperado de la aplicación, recuperar el error que ha notificado el sistema sobre el cierre inesperado, formar un crashlog con la información recopilada y permitir definir el destino del crashlog.

\subsection{Módulo de envío}
El módulo de envío está integrado por una librería. Esta librería se encarga de enviar los logs y los crashlogs recolectados mediantes peticiones HTTP. Como mínimo esta librería ha de poder formar una petición HTTP conteniendo los eventos recolectados, y enviarla a un destino.

\section{Herramientas utilizadas}

Las herramientas utilizadas para llevar a cabo los módulos han sido librerías para Android.

\subsection{Módulo de recolección}
Para llevar a cabo la recolección de logs se ha utilizado la librería Logback\cite{Tfg:logbackandroid} en su versión para Android. Esta librería permite definir en que punto del programa se quiere generar un log y redirigir la salida del log a diferentes destinos. Esta librería también nos permite editar el formato de salida del log así como la metainformación que se añade al log.

Para llevar a cabo la recolección de crashlogs se ha utilizado la librería ACRA\cite{Tfg:acra}. Esta librería detecta cuando una aplicación ha acabado inesperadamente y genera un crashlog con información de valor para reconocer que puede haber pasado. Esta librería también permite redirigir la salida del crashlog a diferentes destinos, editar el formato de salida del crashlog y la metainformación que se añade al crashlog.

\subsection{Módulo de envío}
Para llevar a cabo el envío de logs y crashlogs se ha utilizado la librería OkHttp\cite{Tfg:okhttp} que permite hacer peticiones HTTP. %%WHY

\section{Configuración del subsistema}

\subsection{Módulo de recolección}


Del módulo de recolección se han configurado los siguientes factores:

\subsubsection{Metadatos}
Metadatos hace referencia a toda la información que se recolecta a parte de la información.


\begin{itemize}
	\item Metadatos
	\item Sintaxis (Estructura) %% De los logs 
	\item Formato %%JSON
	\item Destino %% Archivo en el el path de la app, cuando se cierra se borra
\end{itemize}

%%EL LOG Y EL CRASH COMO ENTE












